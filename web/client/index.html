<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlyFun - Aviation Assistant</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✈️</text></svg>">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- App CSS (contains CSS variables for theming) -->
    <link rel="stylesheet" href="css/style.css?v=1.0">
    <!-- Chatbot CSS -->
    <link rel="stylesheet" href="css/chatbot.css?v=6.7">

    <style>
        /* ===== FULL HEIGHT SETUP ===== */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container-fluid {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .container-fluid>.row:first-child {
            flex-shrink: 0;
        }

        /* ===== MODE TOGGLE BAR ===== */
        .mode-toggle-bar {
            background: var(--quick-action-bg);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .mode-toggle-switch {
            display: inline-flex;
            background: var(--surface-color);
            border-radius: 8px;
            padding: 4px;
            box-shadow: var(--shadow-sm);
        }

        .mode-toggle-switch input[type="radio"] {
            display: none;
        }

        .mode-toggle-switch label {
            padding: 10px 30px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-secondary);
            border: none;
            background: transparent;
            margin: 0;
        }

        .mode-toggle-switch input:checked+label {
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .mode-shortcuts {
            font-size: 13px;
        }

        .mode-shortcuts kbd {
            background: var(--surface-color);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 11px;
        }

        /* ===== MAIN LAYOUT ===== */
        .main-content-row {
            display: flex;
            gap: 15px;
            width: 100%;
            padding: 0 15px;
            margin: 0;
            flex: 1 1 auto;
            min-height: 0;
            overflow: hidden;
        }

        .left-panel-col {
            display: flex;
            flex-direction: column;
            transition: none;
            /* Disable transition for smooth resizing */
            overflow: hidden;
            flex-shrink: 0;
            flex: 0 0 33.33%;
            max-width: 50%;
            min-width: 250px;
            position: relative;
            height: 100%;
        }

        .resize-handle {
            position: absolute;
            right: -7.5px;
            top: 0;
            bottom: 0;
            width: 15px;
            cursor: col-resize;
            z-index: 1000;
            background: transparent;
            user-select: none;
            touch-action: none;
        }

        .resize-handle:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 3px;
            height: 40px;
            background: #667eea;
            border-radius: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .resize-handle:hover::before,
        .resize-handle.resizing::before {
            opacity: 1;
        }

        .right-content-col {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1 1 auto;
            min-width: 0;
            height: 100%;
            overflow: hidden;
        }

        .map-data-row {
            display: flex;
            gap: 15px;
            flex: 1 1 auto;
            min-height: 0;
            overflow: hidden;
        }

        .map-column-col,
        .right-panel-col {
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            overflow: hidden;
            flex-shrink: 0;
        }

        .map-column-col {
            background: var(--surface-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            position: relative;
            flex: 1 1 50%;
            max-width: 50%;
            min-width: 250px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Ensure map buttons are always on top */
        .map-column-col .map-collapse-btn,
        .map-column-col .map-expand-btn {
            position: absolute;
            pointer-events: auto;
        }

        .right-panel-col {
            flex: 1 1 50%;
            max-width: 50%;
            min-width: 250px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex: 1;
            height: 100%;
            width: 100%;
            max-width: 100%;
            min-height: 0;
        }

        /* Chatbot Expanded Mode - Fixed for all zoom levels */
        /* Account for 15px gap between columns: calc(50% - 7.5px) */
        .main-content-row.chatbot-mode.expanded .left-panel-col {
            flex: 0 0 calc(50% - 7.5px) !important;
            max-width: calc(50% - 7.5px) !important;
            min-width: calc(50% - 7.5px) !important;
            width: calc(50% - 7.5px) !important;
            box-sizing: border-box !important;
        }

        /* Disable resize handle when expanded */
        .main-content-row.chatbot-mode.expanded .resize-handle {
            display: none;
        }

        .main-content-row.chatbot-mode.expanded .right-content-col {
            flex: 0 0 calc(50% - 7.5px) !important;
            max-width: calc(50% - 7.5px) !important;
            min-width: calc(50% - 7.5px) !important;
            width: calc(50% - 7.5px) !important;
            box-sizing: border-box !important;
        }

        .main-content-row.chatbot-mode.expanded .map-column-col {
            flex: 0 0 100% !important;
            max-width: 100% !important;
            min-width: 100% !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }

        .main-content-row.chatbot-mode.expanded .right-panel-col {
            display: none !important;
            flex: 0 0 0 !important;
            width: 0 !important;
            margin: 0 !important;
        }

        /* ===== LEFT PANEL ===== */
        .left-panel {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .panel-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: var(--surface-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .panel-header {
            background: var(--quick-action-bg);
            color: var(--text-primary);
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-header h5 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .panel-actions {
            display: flex;
            gap: 8px;
        }

        .btn-panel-action {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 28px;
            height: 28px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-panel-action:hover {
            background: var(--hover-bg);
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        /* ===== CHATBOT PANEL ===== */
        .quick-actions-new {
            padding: 6px 16px;
            background: var(--quick-action-bg);
            border-bottom: 1px solid var(--quick-action-border);
            overflow-x: auto;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .quick-actions-new::-webkit-scrollbar {
            height: 4px;
        }

        .quick-actions-new::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }

        .chat-messages-new {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--surface-color);
            min-height: 0;
        }

        .chat-messages-new::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages-new::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .chat-input-area-new {
            padding: 16px;
            background: var(--surface-color);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .chat-input-container-new {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        #chat-input-new {
            flex: 1;
            border: 2px solid var(--input-border);
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 150px;
            transition: border-color 0.2s;
            font-family: inherit;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        #chat-input-new:focus {
            outline: none;
            border-color: var(--gradient-start);
        }

        .btn-chat-send {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .btn-chat-send:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-chat-send:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ===== FILTERS PANEL ===== */
        .filters-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .filters-content::-webkit-scrollbar {
            width: 6px;
        }

        .filters-content::-webkit-scrollbar-thumb {
            background: #dee2e6;
            border-radius: 3px;
        }

        .filters-section-full {
            margin-top: 0;
            padding: 0;
            width: 100%;
            flex: 0 0 auto;
            max-height: 40vh;
            overflow-y: auto;
        }

        .filters-panel-full .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filters-panel-full .panel-header h5 {
            margin: 0;
        }

        .filter-mode-toggle {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-mode-toggle:hover {
            background: var(--hover-bg);
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .filter-mode-toggle i {
            font-size: 11px;
        }

        /* Filter sections that are hidden in minimum mode */
        .filters-panel-full.minimum-mode .filter-section-advanced {
            display: none;
        }

        .filters-panel-full.minimum-mode .filters-row.filter-section-advanced {
            display: none;
        }

        .filters-panel-full.minimum-mode .search-hint {
            display: none;
        }

        /* Compact padding in minimum mode */
        .filters-panel-full.minimum-mode .filters-content {
            padding: 8px 15px;
        }

        .filters-panel-full.minimum-mode .filters-row {
            margin-bottom: 8px;
        }

        .filters-panel-full.minimum-mode .quick-filters-row {
            margin-bottom: 8px;
        }

        .filters-panel-full.minimum-mode .panel-header {
            padding: 6px 12px;
        }

        .filters-panel-full.minimum-mode .panel-header h5 {
            font-size: 13px;
        }

        .filters-panel-full {
            background: var(--surface-color);
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .filters-panel-full .panel-header {
            border-radius: 8px 8px 0 0;
        }

        .filters-panel-full .filters-content {
            padding: 25px;
            max-height: none;
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
            margin-bottom: 18px;
        }

        .filter-field {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1 1 220px;
        }

        .filter-field label {
            margin-bottom: 0;
            font-weight: 600;
            white-space: nowrap;
        }

        .filter-field input,
        .filter-field select {
            flex: 1 1 auto;
        }

        .filter-field-full {
            flex: 1 1 100%;
        }

        .quick-filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .quick-filters-row .form-check {
            margin: 0;
        }

        .quick-filters-row .form-check-label {
            font-weight: 500;
        }

        .filters-row.actions-row {
            justify-content: flex-start;
        }

        .filters-row.actions-row .btn {
            flex: 0 0 220px;
        }

        .search-hint {
            display: block;
            margin-top: -10px;
            margin-bottom: 18px;
        }

        /* ===== MAP ===== */
        #map {
            height: 630px;
            width: 100%;
            border-radius: 8px;
        }

        .filter-panel {
            background-color: var(--quick-action-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .filter-panel-horizontal {
            background-color: var(--quick-action-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .legend-horizontal {
            background: var(--surface-color);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            /* Remove height: 100% to prevent expansion */
        }

        .airport-marker {
            cursor: pointer;
        }

        .airport-info {
            max-height: 400px;
            overflow-y: auto;
        }

        .airport-details-panel,
        .aip-data-panel {
            background-color: var(--quick-action-bg);
            border-radius: 8px;
            padding: 15px;
            height: 630px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .airport-info,
        .aip-data-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            min-height: 0;
            /* Important for flex child to shrink */
        }

        /* Ensure the header doesn't take up flex space */
        .airport-details-panel h5,
        .aip-data-panel h5 {
            flex-shrink: 0;
            margin-bottom: 15px;
        }

        #airport-details {
            height: 100%;
        }

        /* REMOVED - Using pure flexbox layout now, no Bootstrap grid classes */

        .aip-section,
        .rules-section {
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--surface-color);
        }

        .aip-section-header,
        .rules-section-header {
            background-color: var(--quick-action-bg);
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: var(--text-primary);
        }

        .aip-section-header:hover,
        .rules-section-header:hover {
            background-color: var(--hover-bg);
        }

        .aip-section-content,
        .rules-section-content {
            padding: 10px 15px;
            display: none;
        }

        .aip-section-content.expanded,
        .rules-section-content.expanded {
            display: block;
        }

        .aip-section-toggle,
        .rules-section-toggle {
            transition: transform 0.2s ease;
        }

        .aip-section-toggle.expanded,
        .rules-section-toggle.expanded {
            transform: rotate(90deg);
        }

        .aip-entry,
        .rules-entry {
            background-color: var(--quick-action-bg);
            border-left: 4px solid var(--primary-color);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .aip-entry.hidden,
        .rules-entry.hidden {
            display: none;
        }

        .aip-entry.highlight,
        .rules-entry.highlight {
            background-color: var(--thinking-bg);
            border-left-color: var(--thinking-border);
        }

        .rules-entry .rule-question {
            font-weight: 600;
            display: block;
            margin-bottom: 4px;
        }

        .rules-entry .rule-answer {
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .rules-entry .rule-links {
            font-size: 0.85rem;
        }

        .rules-entry .badge {
            margin-right: 6px;
        }

        .airport-detail-section .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        .airport-detail-section .btn i {
            margin-right: 0.25rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .airport-detail-section {
            margin-bottom: 20px;
        }

        .procedure-badge {
            margin: 2px;
        }

        .aip-entry {
            background-color: var(--quick-action-bg);
            border-left: 4px solid var(--primary-color);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .runway-info {
            background-color: var(--quick-action-bg);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .legend {
            background: var(--surface-color);
            padding: 10px;
            border-radius: 4px;
            box-shadow: var(--shadow-sm);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .legend-line {
            width: 30px;
            height: 4px;
            margin-right: 8px;
            border-radius: 2px;
        }

        .legend-transparent {
            background-color: rgba(128, 128, 128, 0.3) !important;
            border: 1px solid rgba(128, 128, 128, 0.5) !important;
        }

        .filter-section-header {
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }

        .filter-section-header:hover {
            background-color: var(--hover-bg);
        }

        .filter-section-content {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .aip-preset-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .aip-preset-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--surface-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .aip-preset-btn:hover {
            background-color: var(--hover-bg);
            border-color: var(--text-secondary);
        }

        .aip-preset-btn.active {
            background-color: #0d6efd;
            border-color: #0d6efd;
            color: #fff;
        }

        .aip-preset-btn .icon {
            font-size: 1rem;
        }

        /* ===== RIGHT PANEL ===== */
        .right-panel {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: all 0.3s ease;
            background: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow-md);
            height: 100%;
            overflow: hidden;
            /* Parent doesn't scroll */
        }

        /* Airport content container */
        #airport-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        /* Tab navigation styling */
        #airport-tabs {
            flex-shrink: 0;
            border-bottom: 2px solid var(--border-color);
        }

        #airport-tabs .nav-link {
            color: var(--text-secondary);
            border: none;
            border-bottom: 3px solid transparent;
            padding: 10px 15px;
            font-weight: 500;
            transition: all 0.2s;
        }

        #airport-tabs .nav-link:hover {
            color: var(--gradient-start);
            border-bottom-color: rgba(102, 126, 234, 0.3);
        }

        #airport-tabs .nav-link.active {
            color: var(--gradient-start);
            background: transparent;
            border-bottom-color: var(--gradient-start);
        }

        /* Tab content styling */
        .tab-content {
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .tab-pane {
            height: 100%;
        }

        .tab-pane-content {
            height: 100%;
            overflow-y: auto;
            padding: 15px 0;
        }

        /* Scrollbar for tab panes */
        .tab-pane-content::-webkit-scrollbar {
            width: 6px;
        }

        .tab-pane-content::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .tab-pane-content::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        /* When right panel collapses, it becomes thin */
        .right-panel-col.collapsed {
            flex: 0 0 40px !important;
            max-width: 40px !important;
            min-width: 40px !important;
        }

        /* Map expands when right panel is collapsed - Fixed for all zoom levels */
        /* Total to subtract: 15px (gap in map-data-row) + 40px (collapsed panel) = 55px */
        .map-column-col.map-expanded,
        .map-data-row.data-collapsed .map-column-col {
            flex: 0 0 calc(100% - 55px) !important;
            max-width: calc(100% - 55px) !important;
            min-width: calc(100% - 55px) !important;
            width: calc(100% - 55px) !important;
            box-sizing: border-box !important;
        }

        /* Map collapses when map-collapsed class is added */
        .map-column-col.map-collapsed {
            flex: 0 0 40px !important;
            max-width: 40px !important;
            min-width: 40px !important;
            width: 40px !important;
            box-sizing: border-box !important;
        }

        .map-column-col.map-collapsed>*:not(.map-collapse-btn):not(.map-expand-btn) {
            display: none !important;
        }

        /* Hide legend when map is collapsed */
        .map-data-row.map-collapsed .legend-panel {
            display: none !important;
        }

        /* Expand airport content to fill space when legend is hidden (map collapsed) */
        .map-data-row.map-collapsed .right-panel {
            gap: 0;
            height: 100% !important;
            min-height: 100%;
        }

        /* Make airport content expand to fill all available space when legend is hidden */
        .map-data-row.map-collapsed .right-panel #airport-content {
            flex: 1 1 100% !important;
            min-height: 0;
            max-height: none !important;
            height: 100%;
        }

        /* Ensure tab content expands fully */
        .map-data-row.map-collapsed .right-panel .tab-content {
            flex: 1 1 auto !important;
            min-height: 0;
            height: 100%;
        }

        /* Ensure tab pane content expands */
        .map-data-row.map-collapsed .right-panel .tab-pane-content {
            height: 100%;
        }

        /* Ensure details panel expands when legend is hidden */
        .map-data-row.map-collapsed .right-panel #airport-details {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Remove max-height constraint on airport-info when map is collapsed */
        .map-data-row.map-collapsed .right-panel .airport-info {
            max-height: none !important;
            flex: 1 1 auto;
            min-height: 0;
            height: 100%;
        }

        /* Ensure no-selection message also expands when legend is hidden */
        .map-data-row.map-collapsed .right-panel #no-selection {
            flex: 1 1 100% !important;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
            height: 100%;
        }

        /* Right panel expands when map is collapsed */
        .map-data-row.map-collapsed .right-panel-col {
            flex: 0 0 calc(100% - 55px) !important;
            max-width: calc(100% - 55px) !important;
            min-width: calc(100% - 55px) !important;
            width: calc(100% - 55px) !important;
            height: 100% !important;
            box-sizing: border-box !important;
        }

        .right-panel.collapsed>*:not(.collapse-btn) {
            display: none !important;
        }

        .collapse-btn,
        .map-collapse-btn,
        .map-expand-btn {
            position: absolute;
            width: 30px;
            height: 30px;
            border: none;
            background: var(--surface-color);
            border-radius: 50%;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .collapse-btn {
            top: 10px;
            left: 5px;
            z-index: 10;
        }

        .map-collapse-btn {
            top: 10px;
            right: 5px;
            z-index: 10000 !important;
            /* Very high z-index to be above Leaflet map controls (typically 400-1000) */
        }

        .map-expand-btn {
            top: 10px;
            left: 5px;
            z-index: 10000 !important;
            /* Very high z-index to be above Leaflet map controls */
        }

        .collapse-btn:hover,
        .map-collapse-btn:hover,
        .map-expand-btn:hover {
            background: var(--quick-action-bg);
            transform: scale(1.1);
        }

        .right-panel.collapsed .collapse-btn {
            left: 5px;
        }

        .right-panel.collapsed .collapse-btn i {
            transform: rotate(180deg);
        }

        /* Hide map collapse button when map is collapsed */
        .map-column-col.map-collapsed .map-collapse-btn {
            display: none !important;
        }

        /* Show map expand button when map is collapsed */
        .map-column-col.map-collapsed .map-expand-btn {
            display: flex !important;
        }

        /* Hide map expand button when map is not collapsed */
        .map-column-col:not(.map-collapsed) .map-expand-btn {
            display: none !important;
        }

        /* Always show map collapse button when map is not collapsed */
        .map-column-col:not(.map-collapsed) .map-collapse-btn {
            display: flex !important;
        }

        /* Hide collapse data button when map is collapsed */
        .map-data-row.map-collapsed .right-panel-col .collapse-btn {
            display: none !important;
        }

        /* Hide collapse map button when data panel is collapsed */
        .map-data-row.data-collapsed .map-column-col .map-collapse-btn {
            display: none !important;
        }

        /* Hide map expand button when data panel is collapsed (only show data expand button) */
        .map-data-row.data-collapsed .map-column-col .map-expand-btn {
            display: none !important;
        }

        .legend-panel {
            background: var(--surface-color);
            padding: 10px 12px;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
            margin-top: auto;
            flex-shrink: 0;
        }

        .legend-content-collapsible {
            margin-top: 8px;
            transition: max-height 0.3s ease, opacity 0.2s ease;
            overflow: hidden;
        }

        .legend-panel.collapsed .legend-content-collapsible {
            max-height: 0 !important;
            opacity: 0;
            margin-top: 0;
        }

        .legend-panel.collapsed #legend-toggle i {
            transform: rotate(-90deg);
        }

        #legend-toggle i {
            transition: transform 0.2s ease;
        }

        /* ===== RESPONSIVE DESIGN: IPAD ===== */
        @media (max-width: 1024px) and (min-width: 768px) {

            /* iPad: Use flex layout */
            .main-content-row .left-panel-col {
                flex: 0 0 33.33% !important;
                max-width: 33.33% !important;
            }

            .right-content-col {
                flex: 1 1 66.67% !important;
            }

            .map-column-col,
            .right-panel-col {
                flex: 1 1 50% !important;
                max-width: 50% !important;
                min-width: 0;
            }

            /* Compact header and spacing on iPad */
            .mt-2 {
                margin-top: 0.5rem !important;
            }

            .mb-2 {
                margin-bottom: 0.5rem !important;
            }

            h2 {
                font-size: 1.5rem !important;
            }

            .text-muted {
                font-size: 0.85rem !important;
                margin-bottom: 0.5rem !important;
            }

            /* Reduce gap between sections */
            .main-content-row {
                gap: 10px !important;
            }

            .right-content-col {
                gap: 10px !important;
            }

            .map-data-row {
                gap: 10px !important;
            }

            /* Chatbot expanded mode MUST come last to override */
            /* Account for gap: Use calc(50% - 5px) for 10px gap on iPad */
            .main-content-row.chatbot-mode.expanded .left-panel-col {
                flex: 0 0 calc(50% - 5px) !important;
                max-width: calc(50% - 5px) !important;
                min-width: calc(50% - 5px) !important;
                width: calc(50% - 5px) !important;
                box-sizing: border-box !important;
            }

            .main-content-row.chatbot-mode.expanded .right-content-col {
                flex: 0 0 calc(50% - 5px) !important;
                max-width: calc(50% - 5px) !important;
                min-width: calc(50% - 5px) !important;
                width: calc(50% - 5px) !important;
                box-sizing: border-box !important;
            }

            .main-content-row.chatbot-mode.expanded .map-column-col {
                flex: 0 0 100% !important;
                max-width: 100% !important;
                min-width: 100% !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }

            .main-content-row.chatbot-mode.expanded .right-panel-col {
                display: none !important;
                flex: 0 0 0 !important;
                width: 0 !important;
                margin: 0 !important;
            }

            /* Right panel collapse - Map expands on iPad - Fixed for all zoom levels */
            .right-panel-col.collapsed {
                flex: 0 0 40px !important;
                max-width: 40px !important;
                min-width: 40px !important;
            }

            /* iPad has 10px gap, so total: 20px (gaps) + 40px (collapsed) = 60px */
            .map-column-col.map-expanded {
                flex: 0 0 calc(100% - 50px) !important;
                max-width: calc(100% - 50px) !important;
                min-width: calc(100% - 50px) !important;
                width: calc(100% - 50px) !important;
                box-sizing: border-box !important;
            }

            /* Map collapses on iPad */
            .map-column-col.map-collapsed {
                flex: 0 0 40px !important;
                max-width: 40px !important;
                min-width: 40px !important;
                width: 40px !important;
                box-sizing: border-box !important;
            }

            /* Right panel expands when map is collapsed on iPad */
            .map-data-row.map-collapsed .right-panel-col {
                flex: 0 0 calc(100% - 50px) !important;
                max-width: calc(100% - 50px) !important;
                min-width: calc(100% - 50px) !important;
                width: calc(100% - 50px) !important;
                box-sizing: border-box !important;
            }
        }

        /* ===== RESPONSIVE DESIGN: IPHONE & MOBILE ===== */
        @media (max-width: 767px) {

            /* iPhone and Mobile */
            .main-content-row {
                flex-direction: column;
                gap: 15px;
            }

            .left-panel-col,
            .right-content-col {
                flex: 1 1 auto !important;
                width: 100% !important;
                max-width: 100% !important;
            }

            .resize-handle {
                display: none;
            }

            .map-data-row {
                flex-direction: column;
                gap: 15px;
            }

            .map-column-col,
            .right-panel-col {
                flex: 1 1 auto !important;
                width: 100% !important;
                max-width: 100% !important;
                height: auto !important;
                max-height: none !important;
            }

            .main-content-row .left-panel-col {
                order: 1;
            }

            .right-content-col {
                order: 2;
            }

            .map-data-row .map-column-col {
                order: 1;
            }

            .map-data-row .right-panel-col {
                order: 2;
            }

            #map {
                min-height: 300px;
            }

            .mode-toggle-bar {
                flex-direction: column;
                gap: 10px;
            }

            .mode-toggle-switch label {
                padding: 8px 20px;
                font-size: 14px;
            }

            .mode-shortcuts {
                display: none;
                /* Hide keyboard shortcuts on mobile */
            }

            /* Stack stats cards 2x2 on mobile */
            /* Right panel always visible on mobile, not collapsible */
            .right-panel.collapsed {
                width: 100% !important;
                flex: 1 1 auto !important;
            }

            .collapse-btn {
                display: none;
            }

            .right-panel.collapsed>* {
                display: block !important;
            }

            .filters-panel-full .filters-content {
                padding: 20px;
            }

            .filters-row {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-field {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }

            .filter-field label {
                width: 100%;
            }

            .filters-row.actions-row .btn {
                width: 100%;
            }

            .quick-filters-row {
                flex-direction: column;
                align-items: flex-start;
            }
        }

        /* ===== TOUCH-FRIENDLY ADJUSTMENTS ===== */
        @media (hover: none) and (pointer: coarse) {

            /* Touch devices: iPad/iPhone */
            .btn-panel-action,
            .btn-chat-send,
            .collapse-btn {
                min-width: 44px;
                min-height: 44px;
            }

            .mode-toggle-switch label {
                padding: 12px 25px;
                min-height: 44px;
            }

            #chat-input-new {
                font-size: 16px;
                /* Prevent zoom on iOS */
            }

            .form-control,
            .form-select {
                font-size: 16px;
                /* Prevent zoom on iOS */
            }
        }

        /* ===== LANDSCAPE MODE: IPHONE ===== */
        @media (max-width: 896px) and (orientation: landscape) {
            #map {
                min-height: 200px;
            }
        }

        /* ===== IPAD PRO 12.9" ===== */
        @media (min-width: 1024px) and (max-width: 1366px) {

            /* Keep equal widths to match stats cards */
            .main-content-row .left-panel-col {
                flex: 0 0 33.33% !important;
                max-width: 33.33% !important;
            }

            .right-content-col {
                flex: 1 1 66.67% !important;
            }

            .map-column-col,
            .right-panel-col {
                flex: 1 1 50% !important;
                max-width: 50% !important;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row align-items-center" style="padding: 6px 15px;">
            <div class="col-12">
                <div class="d-flex align-items-center gap-3">
                    <!-- Title left -->
                    <h5 class="mb-0" style="white-space: nowrap;">
                        <i class="fas fa-plane"></i> FlyFun
                    </h5>
                    <!-- Tagline centered -->
                    <span class="text-muted small flex-grow-1 text-center" style="white-space: nowrap;">Your intelligent aviation assistant</span>
                    <!-- Controls right -->
                    <div class="d-flex align-items-center gap-2" style="white-space: nowrap;">
                        <select class="form-select form-select-sm" id="persona-selector"
                            style="width: auto; min-width: 150px; padding: 2px 24px 2px 8px; font-size: 12px;" title="Select pilot persona">
                            <option value="ifr_touring_sr22">IFR Touring (SR22)</option>
                        </select>
                        <button class="btn btn-outline-secondary btn-sm py-0 px-2" id="theme-toggle" title="Toggle theme" style="font-size: 12px;">
                            <i class="fas fa-circle-half-stroke"></i>
                        </button>
                        <button class="btn btn-outline-primary btn-sm py-0 px-2 d-flex align-items-center gap-1" id="share-button" title="Copy shareable URL" style="font-size: 12px;">
                            <i class="fas fa-share-alt"></i> <span>Share</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- Main Content -->
        <div class="main-content-row chatbot-mode">
            <!-- Left Panel: Chatbot (Full Height) -->
            <div class="left-panel-col" id="left-panel-col">
                <div class="resize-handle" id="resize-handle"></div>
                <div id="left-panel" class="left-panel">
                    <!-- Chatbot Panel -->
                    <div id="chatbot-panel-new" class="panel-content">
                        <div class="panel-header">
                            <h5><i class="fas fa-robot"></i> FlyFun Assistant</h5>
                            <div class="panel-actions">
                                <button id="chatbot-expand-btn-new" class="btn-panel-action" title="Expand (Ctrl+E)">
                                    <i class="fas fa-expand"></i>
                                </button>
                                <button id="chatbot-clear-btn-new" class="btn-panel-action" title="Clear conversation">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="quick-actions-new">
                            <div id="quick-actions-container-new">
                                <!-- Quick action buttons will be loaded here -->
                            </div>
                        </div>

                        <!-- Chat Messages -->
                        <div id="chat-messages-new" class="chat-messages-new">
                            <!-- Messages will be added here dynamically -->
                        </div>

                        <!-- Chat Input -->
                        <div class="chat-input-area-new">
                            <div class="chat-input-container-new">
                                <textarea id="chat-input-new" placeholder="Ask about airports, routes, or facilities..."
                                    rows="1"></textarea>
                                <button id="chat-send-btn-new" class="btn-chat-send">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Content: Map, Data, and Filters -->
            <div class="right-content-col">
                <!-- Map and Data Row -->
                <div class="map-data-row" id="map-data-row">
                    <!-- Map (Center) -->
                    <div class="map-column-col" id="map-column-col">
                        <button class="map-collapse-btn" id="map-collapse-btn" title="Collapse map">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="map-expand-btn" id="map-expand-btn" title="Expand map">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <div id="map"></div>

                        <!-- Loading Indicator -->
                        <div class="loading" id="loading">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading airports...</p>
                        </div>
                    </div>

                    <!-- Right Panel: Airport Details + AIP + Legend -->
                    <div class="right-panel-col">
                        <div id="right-panel" class="right-panel">
                            <button class="collapse-btn" id="right-panel-collapse" title="Collapse panel">
                                <i class="fas fa-chevron-right"></i>
                            </button>

                            <!-- No Selection Message -->
                            <div id="no-selection">
                                <div class="text-center text-muted">
                                    <i class="fas fa-map-marker-alt fa-3x mb-3"></i>
                                    <p>Click on an airport marker to view details</p>
                                </div>
                            </div>

                            <!-- Tabbed Content (shown when airport selected) -->
                            <div id="airport-content" style="display: none;">
                                <!-- Tab Navigation -->
                                <ul class="nav nav-tabs" id="airport-tabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab"
                                            data-bs-target="#details-panel" type="button" role="tab">
                                            <i class="fas fa-info-circle"></i> Details
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="aip-tab" data-bs-toggle="tab"
                                            data-bs-target="#aip-panel" type="button" role="tab">
                                            <i class="fas fa-file-alt"></i> AIP Data
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="rules-tab" data-bs-toggle="tab"
                                            data-bs-target="#rules-panel" type="button" role="tab">
                                            <i class="fas fa-scale-balanced"></i> Rules
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="relevance-tab" data-bs-toggle="tab"
                                            data-bs-target="#relevance-panel" type="button" role="tab">
                                            <i class="fas fa-star"></i> Relevance
                                        </button>
                                    </li>
                                </ul>

                                <!-- Tab Content -->
                                <div class="tab-content" id="airport-tabs-content">
                                    <!-- Airport Details Tab -->
                                    <div class="tab-pane fade show active" id="details-panel" role="tabpanel">
                                        <div class="tab-pane-content">
                                            <div id="airport-details">
                                                <div class="airport-info" id="airport-info">
                                                    <!-- Airport details will be populated here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- AIP Data Tab -->
                                    <div class="tab-pane fade" id="aip-panel" role="tabpanel">
                                        <div class="tab-pane-content">
                                            <div id="aip-data">
                                                <!-- AIP Filter -->
                                                <div class="aip-filter mb-3">
                                                    <div class="input-group input-group-sm">
                                                        <input type="text" class="form-control" id="aip-filter-input"
                                                            placeholder="Filter AIP entries...">
                                                        <button class="btn btn-outline-secondary" type="button"
                                                            id="aip-filter-clear">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>

                                                <div class="aip-data-content" id="aip-data-content">
                                                    <!-- AIP data will be populated here -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Rules Tab -->
                                    <div class="tab-pane fade" id="rules-panel" role="tabpanel">
                                        <div class="tab-pane-content">
                                            <div id="rules-summary" class="mb-3 text-muted small"></div>
                                            <div class="rules-filter mb-3">
                                                <div class="input-group input-group-sm">
                                                    <input type="text" class="form-control" id="rules-filter-input"
                                                        placeholder="Filter rules by question, answer, tag, or category...">
                                                    <button class="btn btn-outline-secondary" type="button"
                                                        id="rules-filter-clear">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="rules-content">
                                                <div class="text-center text-muted py-4">
                                                    <i class="fas fa-info-circle"></i> Select an airport to load country
                                                    rules
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- GA Relevance Tab -->
                                    <div class="tab-pane fade" id="relevance-panel" role="tabpanel">
                                        <div class="tab-pane-content">
                                            <div id="relevance-content">
                                                <div class="text-center text-muted py-4" id="relevance-loading">
                                                    <i class="fas fa-spinner fa-spin"></i> Loading GA data...
                                                </div>
                                                <div id="relevance-data" style="display: none;">
                                                    <!-- GA relevance data will be populated here -->
                                                </div>
                                                <div id="relevance-no-data" style="display: none;">
                                                    <div class="text-center text-muted py-4">
                                                        <i class="fas fa-info-circle"></i> No GA friendliness data
                                                        available for this airport
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Legend (Collapsible) -->
                            <div class="legend-panel" id="legend-panel">
                                <div class="legend-horizontal" id="legend">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center gap-2">
                                            <button class="btn btn-sm btn-link p-0 text-secondary" id="legend-toggle" title="Toggle legend">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                            <h6 class="mb-0" style="font-size: 13px;"><i class="fas fa-info-circle"></i> Legend</h6>
                                        </div>
                                        <select class="form-select form-select-sm" id="legend-mode-filter"
                                            style="width: auto; font-size: 11px; padding: 2px 20px 2px 6px;">
                                            <option value="airport-type" selected>Airport Type</option>
                                            <option value="procedure-precision">Procedure</option>
                                            <option value="runway-length">Runway</option>
                                            <option value="country">Country</option>
                                            <option value="relevance">Relevance</option>
                                            <option value="notification">Notification</option>
                                        </select>
                                    </div>
                                    <div id="legend-content" class="legend-content-collapsible">
                                        <!-- Legend content will be dynamically updated -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters Section (Below Map and Data) -->
                <div class="filters-section-full">
                    <div id="filters-panel-new" class="filters-panel-full">
                        <div class="panel-header">
                            <h5><i class="fas fa-filter"></i> Classic Filters</h5>
                            <button class="filter-mode-toggle" id="filter-mode-toggle" title="Toggle filter mode">
                                <i class="fas fa-compress-alt"></i>
                                <span>Minimum</span>
                            </button>
                        </div>

                        <div class="filters-content">
                            <!-- Quick Filters Row - Compact -->
                            <div class="filters-row quick-filters-row" style="gap: 8px; align-items: center; flex-wrap: wrap;">
                                <span class="text-muted small" style="font-weight: 500;">has</span>
                                <div class="form-check form-check-inline mb-0">
                                    <input class="form-check-input" type="checkbox" id="has-procedures">
                                    <label class="form-check-label small" for="has-procedures">Procedure</label>
                                </div>
                                <div class="form-check form-check-inline mb-0">
                                    <input class="form-check-input" type="checkbox" id="has-hard-runway">
                                    <label class="form-check-label small" for="has-hard-runway">Hard Runway</label>
                                </div>
                                <div class="form-check form-check-inline mb-0">
                                    <input class="form-check-input" type="checkbox" id="border-crossing-only">
                                    <label class="form-check-label small" for="border-crossing-only"><i class="fas fa-passport"></i> Border</label>
                                </div>
                                <span class="text-muted mx-2">|</span>
                                <div class="d-flex align-items-center gap-1">
                                    <i class="fas fa-bed text-muted small"></i>
                                    <select class="form-select form-select-sm py-0" id="hotel-filter" style="width: auto; font-size: 12px;">
                                        <option value="">Hotel</option>
                                        <option value="at_airport">At Airport</option>
                                        <option value="vicinity">Vicinity</option>
                                    </select>
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <i class="fas fa-utensils text-muted small"></i>
                                    <select class="form-select form-select-sm py-0" id="restaurant-filter" style="width: auto; font-size: 12px;">
                                        <option value="">Restaurant</option>
                                        <option value="at_airport">At Airport</option>
                                        <option value="vicinity">Vicinity</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Hidden checkbox to maintain compatibility -->
                            <input type="checkbox" id="has-aip-data" style="display: none;">

                            <!-- Search Row -->
                            <div class="filters-row">
                                <div class="filter-field filter-field-full">
                                    <label for="search-input">Search Airports</label>
                                    <input type="text" class="form-control" id="search-input"
                                        placeholder="ICAO, name, city, or route...">
                                </div>
                            </div>
                            <small class="form-text text-muted search-hint">For routes: space-separated ICAO
                                codes</small>

                            <!-- Route / Country / Max Airports Row -->
                            <div class="filters-row filter-section-advanced">
                                <div class="filter-field">
                                    <label for="route-distance">Route Distance (nm)</label>
                                    <input type="number" class="form-control" id="route-distance" value="50" min="1"
                                        max="500" step="5">
                                </div>
                                <div class="filter-field">
                                    <label for="enroute-distance">Max Enroute Distance (nm)</label>
                                    <input type="number" class="form-control" id="enroute-distance"
                                        placeholder="(optional)" min="1" max="5000" step="10">
                                </div>
                                <div class="filter-field">
                                    <label for="country-filter">Country</label>
                                    <select class="form-select" id="country-filter">
                                        <option value="">All Countries</option>
                                    </select>
                                </div>
                                <div class="filter-field">
                                    <label for="max-airports-filter">Max Airports</label>
                                    <select class="form-select" id="max-airports-filter">
                                        <option value="500">500</option>
                                        <option value="1000">1000</option>
                                        <option value="2000">2000</option>
                                        <option value="5000">5000</option>
                                        <option value="10000" selected>10000</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="filters-row actions-row filter-section-advanced">
                                <button class="btn btn-success" id="locate-button">
                                    <i class="fas fa-location-crosshairs"></i> Locate
                                </button>
                                <button class="btn btn-primary" id="apply-filters">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                                <button class="btn btn-outline-secondary" id="reset-zoom">
                                    <i class="fas fa-expand-arrows-alt"></i> Reset Zoom
                                </button>
                                <button class="btn btn-outline-secondary" id="clear-filters">
                                    <i class="fas fa-eraser"></i> Clear Filters
                                </button>
                            </div>

                        </div>
                    </div>
                </div>

            </div>


            <!-- Bootstrap JS -->
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
            <!-- Leaflet JS -->
            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
            <!-- Chart.js -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

            <!-- Filter Mode Toggle Script -->
            <script>
                (function () {
                    const filterModeToggle = document.getElementById('filter-mode-toggle');
                    const filtersPanel = document.getElementById('filters-panel-new');

                    if (!filterModeToggle || !filtersPanel) return;

                    // Check localStorage for saved preference
                    const savedMode = localStorage.getItem('filterMode') || 'minimum';
                    if (savedMode === 'minimum') {
                        filtersPanel.classList.add('minimum-mode');
                        updateToggleButton('minimum');
                    } else {
                        filtersPanel.classList.remove('minimum-mode');
                        updateToggleButton('all');
                    }

                    function updateToggleButton(mode) {
                        const icon = filterModeToggle.querySelector('i');
                        const text = filterModeToggle.querySelector('span');

                        if (mode === 'minimum') {
                            icon.className = 'fas fa-expand-alt';
                            text.textContent = 'All';
                            filterModeToggle.title = 'Show all filters';
                        } else {
                            icon.className = 'fas fa-compress-alt';
                            text.textContent = 'Minimum';
                            filterModeToggle.title = 'Show minimum filters';
                        }
                    }

                    filterModeToggle.addEventListener('click', () => {
                        const isMinimum = filtersPanel.classList.contains('minimum-mode');

                        if (isMinimum) {
                            filtersPanel.classList.remove('minimum-mode');
                            updateToggleButton('all');
                            localStorage.setItem('filterMode', 'all');
                        } else {
                            filtersPanel.classList.add('minimum-mode');
                            updateToggleButton('minimum');
                            localStorage.setItem('filterMode', 'minimum');
                        }
                    });
                })();
            </script>

            <!-- Legend Collapse/Expand Script -->
            <script>
                (function () {
                    const legendToggle = document.getElementById('legend-toggle');
                    const legendPanel = document.getElementById('legend-panel');

                    if (!legendToggle || !legendPanel) return;

                    // Check localStorage for saved preference
                    const savedState = localStorage.getItem('legendCollapsed');
                    if (savedState === 'true') {
                        legendPanel.classList.add('collapsed');
                    }

                    legendToggle.addEventListener('click', () => {
                        const isCollapsed = legendPanel.classList.toggle('collapsed');
                        localStorage.setItem('legendCollapsed', isCollapsed);
                    });
                })();
            </script>

            <!-- Map Collapse/Expand Script -->
            <script>
                (function () {
                    const mapCollapseBtn = document.getElementById('map-collapse-btn');
                    const mapExpandBtn = document.getElementById('map-expand-btn');
                    const mapColumnCol = document.getElementById('map-column-col');
                    const mapDataRow = document.getElementById('map-data-row');

                    if (!mapCollapseBtn || !mapExpandBtn || !mapColumnCol || !mapDataRow) return;

                    // Helper function to resize map after panel toggle
                    function resizeMap() {
                        window.dispatchEvent(new CustomEvent('panel-resize'));
                        if (window.leafletMap) {
                            window.leafletMap.invalidateSize();
                        }
                    }

                    mapCollapseBtn.addEventListener('click', () => {
                        mapColumnCol.classList.add('map-collapsed');
                        mapDataRow.classList.add('map-collapsed');
                        // Resize map after CSS transition
                        setTimeout(resizeMap, 50);
                        setTimeout(resizeMap, 350);
                    });

                    mapExpandBtn.addEventListener('click', () => {
                        mapColumnCol.classList.remove('map-collapsed');
                        mapDataRow.classList.remove('map-collapsed');
                        // Resize map after CSS transition
                        setTimeout(resizeMap, 50);
                        setTimeout(resizeMap, 350);
                    });
                })();
            </script>

            <!-- Right Panel Collapse/Expand Script -->
            <script>
                (function () {
                    const rightPanelCollapseBtn = document.getElementById('right-panel-collapse');
                    const rightPanelCol = document.querySelector('.right-panel-col');
                    const rightPanel = document.getElementById('right-panel');
                    const mapDataRow = document.getElementById('map-data-row');

                    if (!rightPanelCollapseBtn || !rightPanelCol || !rightPanel || !mapDataRow) return;

                    // Helper function to resize map after panel toggle
                    function resizeMap() {
                        // Dispatch a custom event that the map component can listen to
                        window.dispatchEvent(new CustomEvent('panel-resize'));

                        // Also try to directly invalidateSize if map is available
                        if (window.leafletMap) {
                            window.leafletMap.invalidateSize();
                        }
                    }

                    rightPanelCollapseBtn.addEventListener('click', () => {
                        const isCollapsed = rightPanelCol.classList.contains('collapsed');

                        if (isCollapsed) {
                            // Expand the panel
                            rightPanelCol.classList.remove('collapsed');
                            rightPanel.classList.remove('collapsed');
                            mapDataRow.classList.remove('data-collapsed');
                        } else {
                            // Collapse the panel
                            rightPanelCol.classList.add('collapsed');
                            rightPanel.classList.add('collapsed');
                            mapDataRow.classList.add('data-collapsed');
                        }

                        // Resize map after CSS transition (300ms typical)
                        setTimeout(resizeMap, 50);
                        setTimeout(resizeMap, 350);
                    });
                })();
            </script>

            <!-- Resize Handle Script -->
            <script>
                (function () {
                    const resizeHandle = document.getElementById('resize-handle');
                    const leftPanelCol = document.getElementById('left-panel-col');
                    const mainContentRow = document.querySelector('.main-content-row');

                    if (!resizeHandle || !leftPanelCol || !mainContentRow) return;

                    let isResizing = false;
                    let startX = 0;
                    let startWidth = 0;

                    resizeHandle.addEventListener('mousedown', (e) => {
                        isResizing = true;
                        startX = e.clientX;
                        startWidth = leftPanelCol.offsetWidth;
                        resizeHandle.classList.add('resizing');
                        document.body.style.cursor = 'col-resize';
                        document.body.style.userSelect = 'none';
                        e.preventDefault();
                    });

                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;

                        const deltaX = e.clientX - startX;
                        const containerWidth = mainContentRow.offsetWidth;
                        const gap = 15; // Gap between columns

                        // Calculate new width as percentage
                        const newWidthPx = startWidth + deltaX;
                        const newWidthPercent = (newWidthPx / containerWidth) * 100;

                        // Clamp between min and max
                        const minPercent = (250 / containerWidth) * 100; // 250px minimum
                        const maxPercent = 50; // 50% maximum

                        const clampedPercent = Math.max(minPercent, Math.min(maxPercent, newWidthPercent));

                        // Apply new width
                        leftPanelCol.style.flex = `0 0 ${clampedPercent}%`;
                        leftPanelCol.style.maxWidth = `${clampedPercent}%`;
                    });

                    document.addEventListener('mouseup', () => {
                        if (isResizing) {
                            isResizing = false;
                            resizeHandle.classList.remove('resizing');
                            document.body.style.cursor = '';
                            document.body.style.userSelect = '';
                            // Dispatch panel-resize to update map viewport
                            window.dispatchEvent(new CustomEvent('panel-resize'));
                        }
                    });

                    // Touch support for mobile/tablet
                    resizeHandle.addEventListener('touchstart', (e) => {
                        isResizing = true;
                        startX = e.touches[0].clientX;
                        startWidth = leftPanelCol.offsetWidth;
                        resizeHandle.classList.add('resizing');
                        e.preventDefault();
                    });

                    document.addEventListener('touchmove', (e) => {
                        if (!isResizing) return;

                        const deltaX = e.touches[0].clientX - startX;
                        const containerWidth = mainContentRow.offsetWidth;

                        const newWidthPx = startWidth + deltaX;
                        const newWidthPercent = (newWidthPx / containerWidth) * 100;

                        const minPercent = (250 / containerWidth) * 100;
                        const maxPercent = 50;

                        const clampedPercent = Math.max(minPercent, Math.min(maxPercent, newWidthPercent));

                        leftPanelCol.style.flex = `0 0 ${clampedPercent}%`;
                        leftPanelCol.style.maxWidth = `${clampedPercent}%`;

                        e.preventDefault();
                    });

                    document.addEventListener('touchend', () => {
                        if (isResizing) {
                            isResizing = false;
                            resizeHandle.classList.remove('resizing');
                            // Dispatch panel-resize to update map viewport
                            window.dispatchEvent(new CustomEvent('panel-resize'));
                        }
                    });
                })();
            </script>

            <!-- TypeScript Application -->
            <!-- In development: Vite will handle /ts/main.ts automatically -->
            <!-- In production: Use /dist/main.iife.js -->
            <script type="module">
                // Auto-detect production vs development
                // Try to load production build first, fallback to dev source
                const script = document.createElement('script');
                script.type = 'module';
                script.src = '/dist/main.iife.js';
                script.onerror = () => {
                    // Fallback to dev source if dist doesn't exist (development mode)
                    const devScript = document.createElement('script');
                    devScript.type = 'module';
                    devScript.src = '/ts/main.ts';
                    document.head.appendChild(devScript);
                };
                document.head.appendChild(script);
            </script>
</body>

</html>